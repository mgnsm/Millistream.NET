variables:
  buildConfiguration: 'Release'

trigger:
  branches:
    include:
    - master
  paths:
    include:
    - Source/Millistream.Streaming/
    - Tests/Millistream.Streaming.IntegrationTests
    - Tests/Millistream.Streaming.UnitTests
    - Build/Millistream.Streaming/*

jobs:
- job: Linux
  pool:
    vmImage: 'ubuntu-18.04'
  steps:
  - template: build.yml

  - template: unit-tests.yml

  - bash: |
     sudo wget "https://packages.millistream.com/apt/sources.list.d/`lsb_release -cs`.list" -O /etc/apt/sources.list.d/millistream.list 
     wget -q "https://packages.millistream.com/D2FCCE35.gpg" -O- | sudo apt-key add - 
     sudo apt update
     sudo apt-get install libmdf
    displayName: Download and Install libmdf

  - template: integration-tests.yml

- job: macOS
  pool:
    vmImage: 'macOS-10.14'
  steps:
  - task: UseDotNet@2
    displayName: 'Install the .NET Core SDK'
    inputs:
      packageType: sdk
      version: 3.x
 
  - template: build.yml

  - template: unit-tests.yml

  - bash: |
     curl -O https://packages.millistream.com/macOS/libmdf-1.0.21.pkg 
     sudo installer -pkg libmdf-1.0.21.pkg -target /
    displayName: Download and Install libmdf

  - template: integration-tests.yml

- job: Windows
  pool:
    vmImage: 'windows-2019'
  variables:
    major: 1
    minor: 1
    patch: $[counter('v112', 3)]
  steps:
  - task: DotNetCoreCLI@2
    displayName: 'Restore NuGet Packages and Build Solution For All TargetFrameworks'
    inputs:
     command: build
     projects: |
       Source/Millistream.Streaming/Millistream.Streaming.csproj
       Tests/Millistream.Streaming.UnitTests/Millistream.Streaming.UnitTests.csproj
       Tests/Millistream.Streaming.IntegrationTests/Millistream.Streaming.IntegrationTests.csproj
     arguments: '-c $(buildConfiguration) -p:Version=$(major).$(minor).$(patch)'

  - template: unit-tests.yml

  - powershell: |
     (new-object System.Net.WebClient).DownloadFile('ftp://ftp.millistream.com/binaries/windows/libmdf-1.0.23.exe','libmdf-1.0.23.exe')
     .\libmdf-1.0.23.exe /S
    displayName: 'Download and Install Native Assemblies'

  - template: integration-tests.yml

  - task: CopyFiles@2
    displayName: 'Copy the .csproj file and the compiled binaries to the staging directory'
    inputs:
     SourceFolder: 'Source/Millistream.Streaming/'
     Contents: |
      Millistream.Streaming.csproj
      bin/$(buildConfiguration)/**
     TargetFolder: '$(Build.ArtifactStagingDirectory)'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifacts'
    inputs:
     pathtoPublish: '$(Build.ArtifactStagingDirectory)' 
     artifactName: 'drop'