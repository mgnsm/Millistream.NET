pool:
  vmImage: 'vs2017-win2016'

variables:
  buildPlatform: 'any cpu'
  buildConfiguration: 'release'
  major: 1
  minor: 1
  patch: $[counter('v110', 0)]

steps:
- task: NuGetCommand@2
  displayName: 'Restore NuGet Packages'
  inputs:
    restoreSolution: Millistream.NET.sln

- task: VSBuild@1
  displayName: 'Build Solution'
  inputs:
    solution: Millistream.NET.sln
    vsVersion: 15.0
    platform: '$(buildPlatform)'
    configuration: '$(buildConfiguration)'

- task: VSTest@2
  displayName: 'Run Unit Tests'
  inputs:
    testAssemblyVer2: |
     Tests\Millistream.Streaming.UnitTests\bin\$(buildConfiguration)\Millistream.Streaming.UnitTests.dll
    vsTestVersion: 15.0

- powershell: '(new-object System.Net.WebClient).DownloadFile(''ftp://ftp.millistream.com/binaries/windows/libmdf-1.0.21.exe'',''libmdf-1.0.21.exe'')' 
  displayName: 'Download Native Assemblies'

- script: 'libmdf-1.0.21.exe /S'
  displayName: 'Install Native Assemblies'

- task: VSTest@2
  displayName: 'Run Integration Tests'
  inputs:
    testAssemblyVer2: |
     Tests\Millistream.Streaming.IntegrationTests\bin\$(buildConfiguration)\**\Millistream.Streaming.IntegrationTests.dll
    runSettingsFile: Tests/Millistream.Streaming.IntegrationTests/TestSettings.runsettings
    overrideTestrunParameters: '-host $(host) -username $(username) -password $(password)'

- task: DotNetCoreCLI@2
  displayName: 'Create NuGet Package'
  inputs:
    command: custom
    projects: Source/Millistream.Streaming/Millistream.Streaming.csproj
    custom: pack
    arguments: '-c $(buildConfiguration) /p:PackageVersion=$(major).$(minor).$(patch) --output $(Build.ArtifactStagingDirectory) --no-build --no-restore'

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact'